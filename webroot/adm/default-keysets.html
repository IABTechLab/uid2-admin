<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
</head>
<body>
<h1>UID2 Admin - Default Keyset Access Management (Sharer)</h1>

<a href="/">Back</a>

<br>
<br>

<h3>Inputs</h3>

<label for="siteId">Site Id:</label>
<input type="text" id="siteId" name="siteId">
<label for="addSiteIds">Add Site Ids:</label>
<input type="text" id="addSiteIds" name="addSiteIds">
<label for="removeSiteIds">Remove Site Ids:</label>
<input type="text" id="removeSiteIds" name="removeSiteIds">

<br>
<br>

<h3>Operations</h3>

<ul>
  <li class="ro-shr" style="display: none"><a href="#" id="doListAll">List All</a></li>
  <li class="ro-shr" style="display: none"><a href="#" id="doList">List</a></li>
  <li class="ro-shr" style="display: none"><a href="#" id="doReset">Reset</a></li>
  <li class="ro-shr" style="display: none"><a href="#" id="doUpdate">Update</a></li>
</ul>

<br>

<h3>Output</h3>

<div id="output">
  <pre id="errorOutput"></pre>
  <pre id="standardOutput"></pre>
</div>

<script language="JavaScript">
  $(document).ready(function () {
    $('#doListAll').on('click', function () {
      doApiCall('GET', '/api/sharing/lists', '#standardOutput', '#errorOutput');
    });

    $('#doList').on('click', function () {
      var siteId = encodeURIComponent($('#siteId').val());
      doApiCall('GET', '/api/sharing/list/' + siteId, '#standardOutput', '#errorOutput');
    });

    $('#doReset').on('click', function () {
      var siteId = encodeURIComponent($('#siteId').val());
      var url = '/api/sharing/list/' + siteId;

      doApiCallWithCallback('GET', url, (text) => {
        const jo = JSON.parse(text);
        const hash = jo.hash;
        doApiCall('POST', url, '#standardOutput', 'errorOutput', JSON.stringify({allowlist: [], hash : hash}))
      }, (err) => {
        $('#errorOutput').html('Error: ' + err.status + ': ' + err.statusText);
      });
    });

    $('#doUpdate').on('click', function () {
      const siteId = encodeURIComponent($('#siteId').val());
      const url = '/api/sharing/list/' + siteId;
      const add = ($('#addSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);
      const remove = ($('#removeSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);

      doApiCallWithCallback('GET', url, (text) => {
        const jo = JSON.parse(text);
        const hash = jo.hash;
        let allowlist = jo.allowlist;

        allowlist = allowlist.filter((value, _, __) => !remove.includes(value))
        allowlist = allowlist.concat(add.filter((value, _, __) => !allowlist.includes(value)))

        doApiCall('POST', url, '#standardOutput', 'errorOutput', JSON.stringify({allowlist: allowlist, hash: hash}))
      }, (err) => {
        $('#errorOutput').html('Error: ' + err.status + ': ' + err.statusText);
      });
    });
  });

</script>

</body>
</html>
