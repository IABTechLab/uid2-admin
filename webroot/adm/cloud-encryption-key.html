<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <style>
        .active { color: darkgreen; }
        .inactive { color: darkred; }
    </style>
</head>
<body>
<h1>UID2 Env - Cloud Encryption Key Management</h1>

<a href="/">Back</a>

<br>
<br>

<div class="ro-adm" style="display: none">
    <h3>Operations</h3>
    <ul>
        <li><a href="#" id="doMeta">Get Metadata</a></li>
        <li><a href="#" id="doList">List Cloud Encryption Keys</a></li>
    </ul>

    <br>

    <h3>Output</h3>
    <div id="output">
        <pre id="errorOutput"></pre>
        <pre id="standardOutput"></pre>
    </div>
    <div id="output-table"></div>
</div>

<script language="JavaScript">
    const grid = new gridjs.Grid({
        columns: [
            {
                name: "Key ID",
                formatter: (cell, row) => {
                    console.log(row.cells);
                    return gridjs.html(`<span class="${row.cells[4].data}">${cell}</span>`)
                }
            },
            {
                name: "Site ID",
                formatter: (cell, row) => {
                    return gridjs.html(`<span class="${row.cells[4].data}">${cell}</span>`)
                }
            },
            {
                name: "Activates",
                formatter: (cell, row) => {
                    return gridjs.html(`<span class="${row.cells[4].data}">${formatDate(cell)}</span>`)
                }
            },
            {
                name: "Created",
                formatter: (cell, row) => {
                    return gridjs.html(`<span class="${row.cells[4].data}">${formatDate(cell)}</span>`)
                }
            },
            {
                name: "Style",
                hidden: true
            }
        ],
        data: [],
        sort: true,
        search: {
            selector: (cell, rowIndex, cellIndex) => {
                if (cellIndex === 0 || cellIndex === 1) {
                    return cell;
                }
            }
        },
        language: {
            search: {
                placeholder: "Search by Key ID or Site ID..."
            }
        }
    })
        .render(document.getElementById("output-table"));

    const formatDate = (text) => {
        const date = new Date(text);
        const options = {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            timeZoneName: "short"
        };
        return date.toLocaleString("en-US", options);
    }

    const updateGrid = (grid, data) => {
        const now = new Date();

        const groupedData = data.cloudEncryptionKeys.reduce((acc, entry) => {
            if (!acc[entry.siteId]) {
                acc[entry.siteId] = [];
            }
            acc[entry.siteId].push(entry);
            return acc;
        }, {});

        const gridData = [];
        for (const siteId in groupedData) {
            const entries = groupedData[siteId];
            const latestEntry = entries.reduce((latest, entry) => new Date(entry.activates) > new Date(latest.activates) ? entry : latest);

            entries.forEach((entry) => {
                let style = "";
                if (entry === latestEntry) {
                    style = "active";
                } else {
                    style = "inactive";
                }

                gridData.push([ entry.id, entry.siteId, entry.activates, entry.created, style ]);
            });
        }

        grid
            .updateConfig({ data: gridData })
            .forceRender();
    }

    const clearGrid = (grid) => {
        grid
            .updateConfig({ data: [] })
            .forceRender();
    }

    $(document).ready(function () {
        $("#doMeta").on("click", function () {
            doApiCall("GET", "/api/cloud-encryption-key/metadata", "#standardOutput", "#errorOutput");
        });

        $("#doList").on("click", function () {
            clearGrid(grid);
            doApiCallWithCallback("GET", "/api/cloud-encryption-key/list", (text) => updateGrid(grid, JSON.parse(text)), errorCallback);
        });
    });
</script>
</body>
</html>
