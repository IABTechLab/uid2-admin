<html>
<head>
  <meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
  <script type="module" src="/js/dangerModal.js"></script>
  <script type="module" src="/js/operations.js"></script>
  <script type="module" src="/js/output.js"></script>
  <script type="module" src="/js/roleBadge.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<h1>UID2 Env - Site Management</h1>

<a href="/">Back</a>

{% if ADD_SITE_MESSAGE %}
<p class="message">{{ ADD_SITE_MESSAGE }}</p>
{% endif %}

<div class="main-content">
  <div class="operations-container"></div>
  <div class="output-container"></div>
</div>

<script type="module">
import { initializeOperations } from '/js/operations.js';
import { initializeOutput } from '/js/output.js';

document.addEventListener('DOMContentLoaded', function () {
  function getTemplateValue(varName, fallback = '') {
    const value = '{{ ' + varName + ' }}';
    const isProcessed = value !== ('{{ ' + varName + ' }}');
    return isProcessed ? value : fallback;
  }

  const addSiteOperation = {
    id: 'doAdd',
    title: 'Add Site',
    role: 'maintainer',
    inputs: [
      {
        id: 'siteName-add',
        name: 'siteName',
        label: 'Name',
        required: true
      },
      {
        id: 'types-add',
        name: 'types',
        label: 'Client Types',
        required: true
      },
      {
        id: 'description-add',
        name: 'description',
        label: 'Description',
        size: "multi-line",
        required: true
      },
      {
        id: 'domainNames-add',
        name: 'domainNames',
        label: 'Domain Names',
        size: "multi-line"
      },
      {
        id: 'appNames-add',
        name: 'appNames',
        label: 'App Names',
        size: "multi-line"
      }
    ],
    apiCall: {
      method: 'POST',
      getUrl: (inputs) => {
        const siteName = encodeURIComponent(inputs.siteName);
        const types = encodeURIComponent(inputs.types);
        const description = encodeURIComponent(inputs.description);
        return `/api/site/add?name=${siteName}&types=${types}&description=${description}`;
      },
      getPayload: (inputs) => {
        const domainNames = (inputs.domainNames || '').replace(/\s+/g, '').split(',').filter(value => value !== "");
        const appNames = (inputs.appNames || '').replace(/\s+/g, '').split(',').filter(value => value !== "");
        return {domain_names: domainNames, app_names: appNames};
      }
    }
  };

  const writeOperations = [];

  // To make this work both with and without Jinja templating (when developing).
  const addSiteMessageExists = getTemplateValue('ADD_SITE_MESSAGE') !== '';
  if (!addSiteMessageExists) {
    writeOperations.push(addSiteOperation);
  }

  const operationConfig = [
    {
      type: 'read-only',
      title: 'Read Only Operations',
      operations: [
        {
          id: 'doList',
          title: 'List Sites',
          role: 'maintainer',
          inputs: [],
          apiCall: {
            method: 'GET',
            url: '/api/site/list'
          }
        },
        {
          id: 'searchList',
          title: 'Search Sites by Site Id',
          role: 'maintainer',
          inputs: [
            {
              id: 'searchSiteId-search',
              name: 'searchSiteId',
              label: 'Site Id',
              required: true
            }
          ],
          apiCall: {
            method: 'GET',
            getUrl: (inputs) => `/api/site/${encodeURIComponent(inputs.searchSiteId)}`
          }
        }
      ]
    },
    {
      type: 'write',
      title: 'Write Operations',
      operations: writeOperations.concat([
        {
          id: 'doEnable',
          title: 'Enable Site',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-enable',
              name: 'siteId',
              label: 'Site Id',
              required: true
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/enable?enabled=true&id=${encodeURIComponent(inputs.siteId)}`
          }
        },
        {
          id: 'doDisable',
          title: 'Disable Site',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-disable',
              name: 'siteId',
              label: 'Site Id',
              required: true
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/enable?enabled=false&id=${encodeURIComponent(inputs.siteId)}`
          }
        },
        {
          id: 'doSetName',
          title: 'Set Name',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-setName',
              name: 'siteId',
              label: 'Site Id',
              required: true
            },
            {
              id: 'siteName-setName',
              name: 'siteName',
              label: 'Name',
              required: true
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/update?id=${encodeURIComponent(inputs.siteId)}&name=${encodeURIComponent(inputs.siteName)}`
          }
        },
        {
          id: 'doSetDescription',
          title: 'Set Description',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-setDesc',
              name: 'siteId',
              label: 'Site Id',
              required: true
            },
            {
              id: 'description-setDesc',
              name: 'description',
              label: 'Description',
              required: true,
              size: "multi-line"
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/update?id=${encodeURIComponent(inputs.siteId)}&description=${encodeURIComponent(inputs.description)}`
          }
        },
        {
          id: 'doSetTypes',
          title: 'Set Types',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-setTypes',
              name: 'siteId',
              label: 'Site Id',
              required: true
            },
            {
              id: 'types-setTypes',
              name: 'types',
              label: 'Client Types'
            }
          ],
          preProcess: async (inputs) => {
            let types = inputs.types || '';
            if (types.length < 1) {
              if (!confirm("You are about to set the Client Types of this to empty. Are you sure?")) {
                return null; // Abort operation
              }
              types = "";
            }
            return { ...inputs, types };
          },
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/set-types?id=${encodeURIComponent(inputs.siteId)}&types=${encodeURIComponent(inputs.types)}`
          }
        },
        {
          id: 'doDomainNames',
          title: 'Set Site Domain Names',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-domains',
              name: 'siteId',
              label: 'Site Id',
              required: true
            },
            {
              id: 'domainNames-domains',
              name: 'domainNames',
              label: 'Domain Names',
              size: "multi-line"
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/domain_names?id=${encodeURIComponent(inputs.siteId)}`,
            getPayload: (inputs) => {
              const domainNames = (inputs.domainNames || '').replace(/\s+/g, '').split(',').filter(value => value !== "");
              return { domain_names: domainNames };
            }
          }
        },
        {
          id: 'doAppNames',
          title: 'Set Site App Names',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-apps',
              name: 'siteId',
              label: 'Site Id',
              required: true
            },
            {
              id: 'appNames-apps',
              name: 'appNames',
              label: 'App Names',
              size: "multi-line"
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/app_names?id=${encodeURIComponent(inputs.siteId)}`,
            getPayload: (inputs) => {
              const appNames = (inputs.appNames || '').replace(/\s+/g, '').split(',').filter(value => value !== "");
              return { app_names: appNames };
            }
          }
        },
        {
          id: 'doSetVisible',
          title: 'Set Visible',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-visible',
              name: 'siteId',
              label: 'Site Id',
              required: true
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/update?id=${encodeURIComponent(inputs.siteId)}&visible=true`
          }
        },
        {
          id: 'doSetNotVisible',
          title: 'Set Not Visible',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-notVisible',
              name: 'siteId',
              label: 'Site Id',
              required: true
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/site/update?id=${encodeURIComponent(inputs.siteId)}&visible=false`
          }
        }
      ])
    }
  ];

  initializeOperations(operationConfig);
  initializeOutput();
});
</script>

</body>
</html>
