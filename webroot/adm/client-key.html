<html>
<head>
  <meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
  <script type="module" src="/js/dangerModal.js"></script>
  <script type="module" src="/js/operations.js"></script>
  <script type="module" src="/js/output.js"></script>
  <script type="module" src="/js/roleBadge.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<h1>UID2 Env - Client Key Management</h1>

<a href="/">Back</a>

<div class="main-content">
  <div class="operations-container"></div>
  <div class="output-container"></div>
</div>

{% if ADD_CLIENT_KEY_MESSAGE %}
<p class="message">{{ ADD_CLIENT_KEY_MESSAGE }}</p>
{% endif %}

<script type="module">
import { initializeOperations } from '/js/operations.js';
import { initializeOutput } from '/js/output.js';

document.addEventListener('DOMContentLoaded', function () {
  function getTemplateValue(varName, fallback = '') {
    const value = '{{ ' + varName + ' }}';
    const isProcessed = value !== ('{{ ' + varName + ' }}');
    return isProcessed ? value : fallback;
  }

  const operationConfig = [
    {
      type: 'read-only',
      title: 'Read Only Operations',
      operations: [
        {
          id: 'doMeta',
          title: 'Get Metadata',
          role: 'maintainer',
          inputs: [],
          apiCall: {
            method: 'GET',
            url: '/api/client/metadata'
          }
        },
        {
          id: 'doList',
          title: 'List All Keys',
          role: 'maintainer',
          inputs: [],
          apiCall: {
            method: 'GET',
            url: '/api/client/list'
          }
        },
        {
          id: 'doSearchBySite',
          title: 'Search by Site ID',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-search',
              name: 'siteId',
              label: 'Site ID',
              required: true,
              size: 1
            }
          ],
          apiCall: {
            method: 'GET',
            getUrl: (inputs) => `/api/client/list/${inputs.siteId}`
          }
        },
        {
          id: 'doSearchByKeyId',
          title: 'Search by Key ID',
          role: 'maintainer',
          inputs: [
            {
              id: 'keyId-search',
              name: 'keyId',
              label: 'Key ID',
              required: true,
              size: 2
            }
          ],
          apiCall: {
            method: 'GET',
            getUrl: (inputs) => `/api/client/keyId?keyId=${inputs.keyId}`
          }
        },
        {
          id: 'doSearchByContact',
          title: 'Search by Contact',
          role: 'maintainer',
          inputs: [
            {
              id: 'contact-search',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            }
          ],
          apiCall: {
            method: 'GET',
            getUrl: (inputs) => `/api/client/contact?contact=${inputs.contact}`
          }
        }
      ]
    },
    {
      type: 'write',
      title: 'Write Operations',
      operations: [
        {
          id: 'doAdd',
          title: 'Add Key',
          role: 'maintainer',
          inputs: [
            {
              id: 'name-add',
              name: 'name',
              label: 'Name',
              required: true,
              size: 2
            },
            {
              id: 'siteId-add',
              name: 'siteId',
              label: 'Site ID',
              required: true,
              size: 1,
              defaultValue: '1'
            },
            {
              id: 'serviceId-add',
              name: 'serviceId',
              label: 'Service ID',
              required: true,
              size: 1,
              defaultValue: '0'
            },
            {
              id: 'roles-add',
              name: 'roles',
              label: 'Roles',
              required: true,
              size: 'multi-line'
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/add?name=${encodeURIComponent(inputs.name)}&roles=${encodeURIComponent(inputs.roles)}&site_id=${inputs.siteId}&service_id=${inputs.serviceId}`
          }
        },
        {
          id: 'doReveal',
          title: 'Reveal Key',
          role: 'elevated',
          inputs: [
            {
              id: 'contact-reveal',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            }
          ],
          apiCall: {
            method: 'GET',
            getUrl: (inputs) => `/api/client/reveal?contact=${encodeURIComponent(inputs.contact)}`
          }
        },
        {
          id: 'doEnable',
          title: 'Enable Key',
          role: 'maintainer',
          inputs: [
            {
              id: 'contact-enable',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            }
          ],
          description: 'Enabling this client key will allow this key to generate UID2s in a server-side integration.',
          preProcess: (inputs) => {
            const message = `Enabling this client key will allow this key to generate UID2s in a server-side integration.\n\nAre you sure you want to enable ${inputs.contact}?`;
            return confirm(message) ? inputs : null;
          },
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/enable?contact=${encodeURIComponent(inputs.contact)}`
          }
        },
        {
          id: 'doDisable',
          title: 'Disable Key',
          role: 'maintainer',
          inputs: [
            {
              id: 'contact-disable',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            }
          ],
          description: 'Disabling this client key will prevent this key from generating UID2s in a server-side integration. Before proceeding, ensure there is no valid traffic, and confirm that the participant has provided consent.',
          preProcess: (inputs) => {
            const message = `Disabling this client key will prevent this key from generating UID2s in a server-side integration.\n\nBefore proceeding, ensure there is no valid traffic, and confirm that the participant has provided consent.\n\nAre you sure you want to disable ${inputs.contact}?`;
            return confirm(message) ? inputs : null;
          },
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/disable?contact=${encodeURIComponent(inputs.contact)}`
          }
        },
        {
          id: 'doUpdateRoles',
          title: 'Update Roles',
          role: 'elevated',
          inputs: [
            {
              id: 'contact-roles',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            },
            {
              id: 'newRoles-roles',
              name: 'newRoles',
              label: 'New Roles',
              required: true,
              size: 'multi-line'
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/roles?contact=${encodeURIComponent(inputs.contact)}&roles=${encodeURIComponent(inputs.newRoles)}`
          }
        },
        {
          id: 'doUpdateSiteAndService',
          title: 'Update Site ID and Service ID',
          role: 'maintainer',
          inputs: [
            {
              id: 'contact-update',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            },
            {
              id: 'newSiteId-update',
              name: 'newSiteId',
              label: 'New Site ID',
              required: true,
              size: 1
            },
            {
              id: 'newServiceId-update',
              name: 'newServiceId',
              label: 'New Service ID',
              required: true,
              size: 1,
              defaultValue: '0'
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/update?contact=${encodeURIComponent(inputs.contact)}&site_id=${inputs.newSiteId}&service_id=${inputs.newServiceId}`
          }
        },
        {
          id: 'doRename',
          title: 'Rename Key',
          role: 'maintainer',
          inputs: [
            {
              id: 'contact-rename',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            },
            {
              id: 'newName-rename',
              name: 'newName',
              label: 'New Name',
              required: true,
              size: 2
            }
          ],
          preProcess: (inputs) => {
            const message = `Are you sure you want to rename the key with contact: ${inputs.contact} to: ${inputs.newName}?`;
            return confirm(message) ? inputs : null;
          },
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/rename?contact=${encodeURIComponent(inputs.contact)}&newName=${encodeURIComponent(inputs.newName)}`
          }
        }
      ]
    },
    {
      type: 'danger-zone',
      title: '☠️ Danger Zone ☠️',
      operations: [
        {
          id: 'doDelete',
          title: 'Delete Key',
          role: 'superuser',
          inputs: [
            {
              id: 'contact-delete',
              name: 'contact',
              label: 'Contact',
              required: true,
              size: 2
            }
          ],
          description: 'This will permanently delete the client key. This action cannot be undone.',
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/del?contact=${encodeURIComponent(inputs.contact)}`
          }
        },
        {
          id: 'doUpdateContact',
          title: 'Update Contact',
          role: 'maintainer',
          inputs: [
            {
              id: 'oldContact-contact',
              name: 'oldContact',
              label: 'Old Contact',
              required: true,
              size: 2
            },
            {
              id: 'newContact-contact',
              name: 'newContact',
              label: 'New Contact',
              required: true,
              size: 2
            }
          ],
          description: 'Low Level Operation - Do Not Use Unless Necessary. This will change the contact identifier for the key.',
          preProcess: (inputs) => {
            const message = `Confirm changing the contact from ${inputs.oldContact} to: ${inputs.newContact}`;
            return confirm(message) ? inputs : null;
          },
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/client/contact?oldContact=${encodeURIComponent(inputs.oldContact)}&newContact=${encodeURIComponent(inputs.newContact)}`
          }
        }
      ]
    }
  ];

  const addKeyMessageExists = getTemplateValue('ADD_CLIENT_KEY_MESSAGE') !== '';
  if (addKeyMessageExists) {
    operationConfig[1].operations = operationConfig[1].operations.filter(op => op.id !== 'doAdd');
  }

  initializeOperations(operationConfig);
  initializeOutput();
});
</script>

</body>
</html>