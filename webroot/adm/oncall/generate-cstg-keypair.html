<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="/js/main.js"></script>

    <style>
        table, th, td {
            border: 1px solid;
            vertical-align: top;
        }
    </style>
</head>
<body>
<h1>UID2 Env - On-call - Generate CSTG Keypair</h1>

<a href="/">Back</a>

<br>
<br>

<div class="ro-adm" style="display: none">
    <h3>Please input the participant's name.</h3>
    <label for="participantName">Name:</label>
    <input type="text" id="participantName" name="participantName">
    <a href="#" id="searchParticipant">Search</a>

    <br>
    <br>

    <table id="searchTable">
        <tr>
            <th>Sites</th>
        </tr>
        <tr>
            <td>
                <pre id="siteSearchOutput"></pre>
            </td>
        </tr>
        <tr>
            <td id="create" colspan="2" style="text-align: center">
                <h3>Didn't find what you were looking for?</h3>
            </td>
        </tr>
        <tr>
            <td>
                <h3>Operations</h3>
                <ul>
                    <li><a href="#create" id="createSite">Create site</a></li>
                </ul>

                <hr>

                <div id="createSite-workflow" style="display: none">
                    <h3>Create a new site</h3>

                    <label for="createSite-workflow-siteName">Name:</label>
                    <input type="text" id="createSite-workflow-siteName" name="createSite-workflow-siteName">

                    <br>

                    <label for="createSite-workflow-siteDomainNames">Domain Names (comma-seperated list):</label>
                    <input type="text" id="createSite-workflow-siteDomainNames" name="createSite-workflow-siteDomainNames">

                    <br>

                    <label for="createSite-workflow-siteDescription">Description (Optional):</label>
                    <input type="text" id="createSite-workflow-siteDescription" name="createSite-workflow-siteDescription">

                    <div>
                        <input type="checkbox" id="createSite-workflow-siteClientTypes-PUBLISHER" name="createSite-workflow-siteClientTypes[]" value="PUBLISHER">
                        <label for="createSite-workflow-siteClientTypes-PUBLISHER">Is this participant a publisher? Only publishers are allowed to use CSTG.</label>
                    </div>

                    <br>

                    <a href="#create" id="createSite-workflow-submit">Create</a>
                </div>
            </td>
        </tr>
    </table>
</div>

<script language="JavaScript">
    $(document).ready(() => {
        $("#searchParticipant").on("click", () => {
            const name = encodeURIComponent($("#participantName").val());
            search("site", name);
        });

        $("#createSite").on("click", () => {
            $("#createSite-workflow").show();
        });

        $("#createSite-workflow-submit").on("click", () => {
            let domainNames = $("#createSite-workflow-siteDomainNames").val().replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "");
            if (domainNames.length === 0) {
                window.alert("Domain names cannot be empty");
                return;
            }

            const isPublisherChecked = $("#createSite-workflow-siteClientTypes-PUBLISHER").is(":checked");
            if (!isPublisherChecked) {
                window.alert("Unable to create site - only publishers are allowed to use CSTG.");
                return;
            } else if (!confirm("Are you sure that this participant is a publisher? Only publishers are allowed to use CSTG.")) {
                return;
            }

            $("#siteSearchOutput").text("");

            const name = encodeURIComponent($("#createSite-workflow-siteName").val());
            const description = encodeURIComponent($("#createSite-workflow-siteDescription").val());
            const createSiteUrl = `/api/site/add?name=${name}&types=PUBLISHER&description=${description}`;

            doApiCallWithCallback("POST", createSiteUrl, (text) => {
                const site = JSON.parse(text);

                const payload = {domain_names: domainNames};

                const setDomainNamesUrl = `/api/site/domain_names?id=${site.id}`;

                doApiCallWithCallback("POST", setDomainNamesUrl, (text) => {
                    const site = JSON.parse(text);

                    const alertMessage = `Created site for [${site.name}] with site ID [${site.id}]`;

const outputMessage = `\
${alertMessage}

--------------------------------------------------

${JSON.stringify(site, null, 2)}`;

                    $("#siteSearchOutput").text(outputMessage);
                    window.alert(alertMessage);
                }, (err) => standardErrorCallback(err, `#siteSearchOutput`), JSON.stringify(payload));
            }, (err) => standardErrorCallback(err, `#siteSearchOutput`));
        });

        const search = (type, name) => {
            $(`#${type}SearchOutput`).text("");

            doApiCallWithCallback("GET", `/api/${type}/list`, (text) => {
                    const searchList = JSON.parse(text);

                    const similarList = searchList.filter(s => s.name.toLowerCase().includes(name.toLowerCase()));
                    if (similarList.length === 0) {
                        $(`#${type}SearchOutput`).text("No results");
                    } else {
                        $(`#${type}SearchOutput`).text(JSON.stringify(similarList, null, 2));
                    }
                }, (err) => standardErrorCallback(err, `#${type}SearchOutput`));
        }
    });
</script>

</body>
</html>
