<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <style>
        .geo {
            display: none;
        }

        .geo .marquee {
            height: 25px;
            width: 420px;

            overflow: hidden;
            position: relative;
        }

        .geo .marquee div {
            display: block;
            width: 200%;
            height: 30px;

            position: absolute;
            overflow: hidden;

            animation: marquee 5s linear infinite;
        }

        .geo .marquee span {
            float: left;
            width: 50%;
        }

        @keyframes marquee {
            0% {
                left: 0;
            }

            100% {
                left: -100%;
            }
        }

        .geo .gif {
            float: left;
            height: 50px !important;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
            <path
                d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
        </symbol>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="display: none;" fill="currentColor"
        class="bi bi-copy" viewBox="0 0 16 16">
        <path fill-rule="evenodd"
            d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z" />
    </svg>

    <div class="container-lg">
        <div class="col-lg">
            <div class="row">
                <h1>UID2 Env - On-call - Generate API Key/Secret</h1>
            </div>
            <div class="row pt-3 pb-2">
                <div class="col-sm">
                    <a href="/">Back</a>
                </div>
            </div>
            <div class="row py-1">
                <div class="col">
                    <h5>Search for existing participants</h5>
                </div>
            </div>
            <div class="row align-items-end">
                <div class="col">
                    <div class="form-group">
                        <label for="participantName">Participant name</label>
                        <input type="text" class="form-control" id="participantName"
                            placeholder="Leave empty for all participants">
                    </div>
                </div>
                <div class="col">
                    <a href="#" class="btn btn-primary" id="searchParticipant">Search</a>
                </div>
            </div>
            <div class="row pt-3">
                <div class="col">
                    <h5>Search Results:</h5>
                </div>
            </div>
            <div class="row">
                <table class="table table-bordered">
                    <thead>
                        <th scope="col" class="col-1">Sites</th>
                        <th scope="col" class="col-1">Clients</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <pre id="siteSearchOutput"></pre>&nbsp;
                            </td>
                            <td>
                                <pre id="clientSearchOutput"></pre>&nbsp;
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="row pt-3">
                <div class="col">
                    <div class="row">
                        <h5>Update Operations:</h5>

                    </div>
                    <div class="row">
                        <div class="col">
                            <button type="button" aria-controls="createSiteRegion" aria-expanded="false" id="createSite"
                                data-bs-parent="#siteParent" class="btn btn-primary" data-bs-toggle="collapse"
                                data-bs-target="#createSiteRegion" role="button">Create site</button>
                            <button type="button" aria-controls="updateSiteRegion" aria-expanded="false" id="updateSite"
                                data-bs-parent="#siteParent" class="btn btn-primary" data-bs-toggle="collapse"
                                data-bs-target="#updateSiteRegion" role="button">Update site</button>
                            <button type="button" aria-controls="createSiteRegion" aria-expanded="false"
                                id="createClient" data-bs-parent="#siteParent" class="btn btn-primary"
                                data-bs-toggle="collapse" data-bs-target="#createClientRegion" role="button">Create
                                client</button>

                        </div>
                    </div>
                    <div id="siteParent" class="col">
                        <div class="row collapse mt-3" id="createSiteRegion" data-bs-parent="#siteParent">
                            <form id="createSiteForm">
                                <div class="card card-body">
                                    <div class="form-group">
                                        <h5>Create a new site</h5>

                                        <label for="createSite-workflow-name">Name:</label>
                                        <input type="text" class="form-control" id="createSite-workflow-name"
                                            name="createSite-workflow-name">
                                        <div class="pt-3">
                                            Client Types:
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="createSite-workflow-clientTypes-DSP"
                                                class="form-check-input" name="createSite-workflow-clientTypes[]"
                                                value="DSP">
                                            <label for="createSite-workflow-clientTypes-DSP">DSP</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="createSite-workflow-clientTypes-ADVERTISER"
                                                class="form-check-input" name="createSite-workflow-clientTypes[]"
                                                value="ADVERTISER">
                                            <label for="createSite-workflow-clientTypes-ADVERTISER">ADVERTISER</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="createSite-workflow-clientTypes-DATA_PROVIDER"
                                                class="form-check-input" name="createSite-workflow-clientTypes[]"
                                                value="DATA_PROVIDER">
                                            <label
                                                for="createSite-workflow-clientTypes-DATA_PROVIDER">DATA_PROVIDER</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="createSite-workflow-clientTypes-PUBLISHER"
                                                class="form-check-input" name="createSite-workflow-clientTypes[]"
                                                value="PUBLISHER">
                                            <label for="createSite-workflow-clientTypes-PUBLISHER">PUBLISHER</label>
                                        </div>
                                        <div class="py-2">
                                            <label for="createSite-workflow-description">Description (Optional):</label>
                                            <input type="text" id="createSite-workflow-description" class="form-control"
                                                name="createSite-workflow-description">
                                        </div>
                                        <a href="#create" class="btn btn-primary"
                                            id="createSite-workflow-submit">Create</a>

                                        <div class="collapse" id="createSiteOutput">
                                            <div class="pt-2">
                                                <div class="py-2">Create Site response:</div>
                                                <div class="alert alert-secondary">
                                                    <button type="button" class="btn float-end" id="copySite"><img
                                                            src="/css/copy.svg" alt="copySite" /></button>
                                                    <pre id="siteJira" class="form-clear"></pre>
                                                </div>
                                                
                                            </div>
                                        </div>
                                        <div class="collapse pt-3" id="createSiteErrorAlert">
                                            <div class="alert alert-danger" ><pre id="createSiteError"></pre></div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="row collapse mt-3" id="updateSiteRegion" data-bs-parent="#siteParent">
                            <form id="updateSiteForm">
                                <div class="card card-body">
                                    <div class="form-group">
                                        <h5>Update an existing site</h5>
                                        <div class="py-2">
                                            <label for="updateSite-workflow-siteId">Site ID:</label>
                                            <input type="text" id="updateSite-workflow-siteId" class="form-control"
                                                name="updateSite-workflow-siteId">
                                        </div>
                                        <a href="#create" id="updateSite-workflow-search"
                                            class="btn btn-primary">Search</a>
                                    </div>

                                    <div class="row pt-3 px-2 collapse" id="updateSite-seachOutput-NoResults">
                                        <div class="alert alert-warning d-flex align-items-center pt-3" role="alert">
                                            <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img"
                                                aria-label="Warning:">
                                                <use xlink:href="#exclamation-triangle-fill" />
                                            </svg>
                                            <div>
                                                No site found
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row pt-3 px-2 collapse" id="updateSite-seachOutput-ErrorAlert">
                                        <div class="alert alert-warning d-flex align-items-center pt-3" role="alert">
                                            <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img"
                                                aria-label="Warning:">
                                                <use xlink:href="#exclamation-triangle-fill" />
                                            </svg>
                                            <pre id="updateSite-searchOutput-ErrorDiv">
                                        </pre>
                                        </div>
                                    </div>

                                    <div id="updateSite-workflow-afterSearch" class="collapse">
                                        <label for="updateSite-workflow-afterSearch-name">Name:</label>
                                        <input type="text" class="form-control"
                                            id="updateSite-workflow-afterSearch-name"
                                            name="updateSite-workflow-afterSearch-name" disabled readonly>

                                        <div class="pt-3">
                                            Client Types:
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="updateSite-workflow-afterSearch-clientTypes-DSP"
                                                class="form-check-input"
                                                name="updateSite-workflow-afterSearch-clientTypes[]" value="DSP">
                                            <label for="updateSite-workflow-afterSearch-clientTypes-DSP">DSP</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox"
                                                id="updateSite-workflow-afterSearch-clientTypes-ADVERTISER"
                                                class="form-check-input"
                                                name="updateSite-workflow-afterSearch-clientTypes[]" value="ADVERTISER">
                                            <label
                                                for="updateSite-workflow-afterSearch-clientTypes-ADVERTISER">ADVERTISER</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox"
                                                id="updateSite-workflow-afterSearch-clientTypes-DATA_PROVIDER"
                                                class="form-check-input"
                                                name="updateSite-workflow-afterSearch-clientTypes[]"
                                                value="DATA_PROVIDER">
                                            <label
                                                for="updateSite-workflow-afterSearch-clientTypes-DATA_PROVIDER">DATA_PROVIDER</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox"
                                                id="updateSite-workflow-afterSearch-clientTypes-PUBLISHER"
                                                class="form-check-input"
                                                name="updateSite-workflow-afterSearch-clientTypes[]" value="PUBLISHER">
                                            <label
                                                for="updateSite-workflow-afterSearch-clientTypes-PUBLISHER">PUBLISHER</label>
                                        </div>

                                        <div class="py-2">
                                            <label for="updateSite-workflow-afterSearch-description">Description
                                                (Optional):</label>
                                            <input type="text" id="updateSite-workflow-afterSearch-description"
                                                class="form-control" name="updateSite-workflow-afterSearch-description">
                                        </div>

                                        <a href="#update" class="btn btn-primary"
                                            id="updateSite-workflow-submit">Update</a>

                                        <div class="collapse" id="updateSiteOutput">
                                            <div class="pt-2">
                                                <div class="py-2">Update Site response:</div>
                                                <div class="alert alert-secondary">
                                                    <button type="button" class="btn float-end"
                                                        id="copyUpdatedSite"><img src="/css/copy.svg"
                                                            alt="Copy Update Site Response" /></button>
                                                    <pre id="siteUpdateJira" class="form-clear"></pre>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="collapse pt-3" id="updateSiteErrorAlert">
                                        <div class="alert alert-danger" ><pre id="updateSiteError"></pre></div>
                                    </div>

                                </div>
                            </form>
                        </div>
                        <div class="row collapse mt-3" id="createClientRegion" data-bs-parent="#siteParent">
                            <form id="createClientForm">
                                <div class="card card-body">
                                    <div class="form-group">
                                        <h5>Create a new client</h5>

                                        <div>
                                            <label for="createClient-workflow-name">Name:</label>
                                            <input type="text" id="createClient-workflow-name" class="form-control"
                                                name="createClient-workflow-name">
                                        </div>
                                        <div class="pt-3">
                                            <label for="createClient-workflow-siteId">Site ID:</label>
                                            <input type="text" id="createClient-workflow-siteId" class="form-control"
                                                name="createClient-workflow-siteId">

                                        </div>
                                        <div class="pt-3">
                                            Roles:
                                            <select id="createClient-workflow-roles" class="form-select">
                                                <option value="" selected>Please select a role...</option>
                                                <option value="GENERATOR">GENERATOR - for publishers</option>
                                                <option value="MAPPER">MAPPER - for advertisers, data providers</option>
                                                <option value="ID_READER">ID_READER - for DSPs</option>
                                            </select>
                                        </div>
                                        <div class="form-check pt-3 pb-2">
                                            <input type="checkbox" class="form-check-input"
                                                id="createClient-workflow-roles-SHARER"
                                                name="createClient-workflow-roles[]" value="SHARER">
                                            <label for="createClient-workflow-roles-SHARER"
                                                class="form-check-label">Does it additionally need the SHARER
                                                role? Be sure that the client definitely needs this. Most don't.</label>
                                        </div>
                                        <a href="#create" class="btn-primary btn"
                                            id="createClient-workflow-submit">Create</a>

                                        <div class="collapse" id="createClientOutput">
                                            <div class="pt-2">
                                                <div class="py-2">Please copy and paste this to a new <a
                                                        href="https://tradesecrets.adsrvr.org/secrets/new">TradeSecret</a>:
                                                </div>
                                                <div class="alert alert-secondary">
                                                    <button type="button" class="btn float-end"
                                                        id="copyTradeSecret"><img src="/css/copy.svg"
                                                            alt="Copy Trade Secret" />
                                                    </button>
                                                    <pre id="tradeSecretSpace" class="form-clear"></pre>
                                                </div>
                                            </div>
                                            <div class="pt-2">
                                                <div class="py-2">Please copy and paste this into a comment on the JIRA
                                                    ticket:
                                                </div>
                                                <div class="alert alert-secondary">
                                                    <button type="button" class="btn float-end" id="copyForJira">
                                                        <img src="/css/copy.svg" alt="Copy for Jira" />
                                                    </button>
                                                    <pre id="jiraSpace" class="form-clear"></pre>
                                                </div>
                                            </div>
                                            <div class="pt-2">
                                                <div class="py-2">This is the output for reference. You should not need
                                                    to copy this.
                                                </div>
                                                <div class="alert alert-dark">
                                                    <pre id="fullClientOutputSpace"
                                                        class="user-select-none form-clear"></pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="collapse pt-3" id="createClientErrorAlert">
                                        <div class="alert alert-danger" ><pre id="createClientError"></pre></div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
                <div class="col">
                    <div class="row">
                        <div class="col">
                        </div>
                    </div>
                    <div id="clientParent" class="col">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script language="JavaScript">
        $(document).ready(() => {
            $("#searchParticipant").on("click", () => {
                const name = $("#participantName").val();

                search("site", name);
                search("client", name);
            });

            $("#createSite-workflow-submit").on("click", () => {
                $("#siteSearchOutput").text("");

                const name = encodeURIComponent($("#createSite-workflow-name").val());
                const clientTypes = $("input[name='createSite-workflow-clientTypes[]']:checked").map((_, el) => encodeURIComponent($(el).val())).get().join(",");
                const description = encodeURIComponent($("#createSite-workflow-description").val());

                const url = `/api/site/add?name=${name}&types=${clientTypes}&description=${description}`;

                doApiCallWithCallback("POST", url, (text) => {
                    document.getElementById("createSiteRegion").addEventListener("hidden.bs.collapse", function () {
                        $("#createSiteRegion").collapse('show');
                        $("#createSiteOutput").collapse('show');
                    }, { once: true });

                    clearForms();
                    const site = JSON.parse(text);
                    const alertMessage = `Created site for [${site.name}] with site ID [${site.id}]`;

                    const outputMessage = `\
${alertMessage}
--------------------------------------------------

${JSON.stringify(site, null, 2)}`;

                    $("#siteJira").text(outputMessage);

                }, (err) => alertErrorCallback(err, "#createSiteError", "#createSiteErrorAlert"));
            });

            $("#updateSite-workflow-search").on("click", () => {
                $("#updateSite-seachOutput-NoResults").hide();
                $("#updateSite-seachOutput-ErrorAlert").hide();
                $("#updateSite-workflow-afterSearch").hide();

                const siteId = encodeURIComponent($("#updateSite-workflow-siteId").val());

                doApiCallWithCallback("GET", "/api/site/list", (text) => {

                    const searchList = JSON.parse(text);

                    const siteList = searchList.filter((site) => site.id.toString() === siteId);
                    if (siteList.length === 0) {
                        $("#updateSite-seachOutput-NoResults").show();
                    } else {
                        $("#updateSite-workflow-afterSearch").show();

                        const site = siteList[0];
                        $("#updateSite-workflow-afterSearch-name").val(site.name);
                        site.clientTypes.forEach((type) => {
                            $(`input[name = "updateSite-workflow-afterSearch-clientTypes[]"][value = "${type}"]`).prop("checked", true)
                        });
                        $("#updateSite-workflow-afterSearch-description").val(site.description);
                    }
                }, (err) => alertErrorCallback(err, "#updateSite-searchOutput-ErrorDiv", "#updateSite-seachOutput-ErrorAlert"));
            });

            $("#updateSite-workflow-submit").on("click", () => {
                $("#siteUpdateJira").text("");
                $("#updateSiteOutput").collapse('hide');

                const id = encodeURIComponent($("#updateSite-workflow-siteId").val());
                const name = $("#updateSite-workflow-afterSearch-name").val();
                const clientTypes = $("input[name='updateSite-workflow-afterSearch-clientTypes[]']:checked").map((_, el) => encodeURIComponent($(el).val())).get().join(",");
                const description = encodeURIComponent($("#updateSite-workflow-afterSearch-description").val());

                const updateClientTypesUrl = `/api/site/set-types?id=${id}&types=${clientTypes}`;
                const updateDescriptionUrl = `/api/site/update?id=${id}&description=${description}`;

                doApiCallWithCallback(
                    "POST",
                    updateClientTypesUrl,
                    () => doApiCallWithCallback(
                        "POST",
                        updateDescriptionUrl,
                        (text) => {
                            document.getElementById("updateSiteRegion").addEventListener("hidden.bs.collapse", function () {
                                $("#updateSiteRegion").collapse('show');
                                $("#updateSiteOutput").collapse('show');
                            }, { once: true });
                            clearForms();

                            const site = JSON.parse(text);

                            const alertMessage = `Updated site [${site.name}] with site ID[${site.id}]`;

                            const outputMessage = `\
${alertMessage}
--------------------------------------------------

${JSON.stringify(site, null, 2)} `;

                            $("#siteUpdateJira").text(outputMessage);

                        },
                        (err) => alertErrorCallback(err, "#updateSiteError", "#updateSiteErrorAlert")
                    ),
                    (err) => alertErrorCallback(err, "#updateSiteError", "#updateSiteErrorAlert")
                );
            });


            $("#createClient-workflow-submit").on("click", () => {
                const isSharerRoleChecked = $("#createClient-workflow-roles-SHARER").is(":checked");
                if (isSharerRoleChecked && !confirm("Are you sure you want to create a client key with the SHARER role?")) {
                    return;
                }

                $("#clientSearchOutput").text("");

                const name = encodeURIComponent($("#createClient-workflow-name").val());
                let roles = encodeURIComponent($("#createClient-workflow-roles").val());
                if (isSharerRoleChecked) {
                    roles += ",SHARER";
                }
                const siteId = encodeURIComponent($("#createClient-workflow-siteId").val());

                const url = `/api/client/add?name=${name}&roles=${roles}&site_id=${siteId}&service_id=0`;

                doApiCallWithCallback("POST", url, (text) => {
                    document.getElementById("createClientRegion").addEventListener("hidden.bs.collapse", function () {
                        $("#createClientRegion").collapse('show');
                        $("#createClientOutput").collapse('show');
                    }, { once: true });
                    document.getElementById("createClientOutput").addEventListener("hidden.bs.collapse", function () {
                        $("#createClientRegion").collapse('show');
                        $("#createClientOutput").collapse('show');
                    }, { once: true });

                    clearForms();
                    const client = JSON.parse(text);

                    const alertMessage = `Created API key for [${client.authorizable.name}] under site ID [${client.authorizable.site_id}]`;

                    const tradeSecretsMessage = `\
Key: ${client.plaintext_key}
Secret: ${client.authorizable.secret} `;

                    $("#tradeSecretSpace").text(tradeSecretsMessage);

                    const jiraBody = JSON.parse(JSON.stringify(client.authorizable));
                    delete jiraBody.key_hash;
                    delete jiraBody.key_salt;
                    delete jiraBody.secret;
                    delete jiraBody.key_id;
                    $("#jiraSpace").text(JSON.stringify(jiraBody, null, 2))

                    const outputMessage = `\
${alertMessage}
--------------------------------------------------

${JSON.stringify(client, null, 2)} `;

                    $("#fullClientOutputSpace").text(outputMessage);

                }, (err) => alertErrorCallback(err, "#createClientError", "#createClientErrorAlert"));
            });

            const search = (type, name) => {
                $(`#${type} SearchOutput`).collapse('show');

                doApiCallWithCallback("GET", `/api/${type}/list`, (text) => {
                    const searchList = JSON.parse(text);

                    const similarList = searchList.filter((obj) => obj.name.toLowerCase().includes(name.toLowerCase()));
                    if (similarList.length === 0) {
                        $(`#${type}SearchOutput`).text("No results");
                    } else {
                        $(`#${type}SearchOutput`).text(JSON.stringify(similarList, null, 2));
                    }
                }, (err) => standardErrorCallback(err, `#${type}SearchOutput`));
            }

            const clearForms = () => {
                $(".form-clear").text("");
                $('.collapse').collapse('hide');
                $("#createSiteForm").trigger("reset");
                $("#updateSiteForm").trigger("reset");
                $("#createClientForm").trigger("reset");
            }

            $("#copyTradeSecret").on("click", () => {
                const text = $("#tradeSecretSpace").text();
                navigator.clipboard.writeText(text);
            });
            $("#copyForJira").on("click", () => {
                const text = $("#jiraSpace").text();
                navigator.clipboard.writeText(text);
            });
            $("#copySite").on("click", () => {
                const text = $("#siteJira").text();
                navigator.clipboard.writeText(text);
            });
            $("#copyUpdatedSite").on("click", () => {
                const text = $("#siteUpdateJira").text();
                navigator.clipboard.writeText(text);
            });
        });
    </script>

</body>

</html>