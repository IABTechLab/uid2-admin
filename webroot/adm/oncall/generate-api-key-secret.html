<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="/js/main.js"></script>

    <style>
        table, th, td {
            border: 1px solid;
            vertical-align: top;
        }
    </style>
</head>
<body>
<h1>UID2 Env - On-call - Generate API Key/Secret</h1>

<a href="/">Back</a>

<br>
<br>

<div class="ro-adm" style="display: none">
    <h3>Please input the participant's name.</h3>
    <label for="participantName">Name:</label>
    <input type="text" id="participantName" name="participantName">
    <a href="#" id="searchParticipant">Search</a>

    <br>
    <br>

    <table id="searchTable">
        <tr>
            <th>Sites</th>
            <th>Clients</th>
        </tr>
        <tr>
            <td><pre id="siteSearchOutput"></pre></td>
            <td><pre id="clientSearchOutput"></pre></td>
        </tr>
        <tr>
            <td id="create" colspan="2" style="text-align: center">
                <h3>Didn't find what you were looking for?</h3>
            </td>
        </tr>
        <tr>
            <td>
                <h3>Operations</h3>
                <ul>
                    <li><a href="#create" id="createSite">Create site</a></li>
                    <li><a href="#create" id="updateSite">Update site - client types and description</a></li>
                </ul>

                <hr>

                <div id="createSite-workflow" style="display: none">
                    <h3>Create a new site</h3>

                    <label for="createSite-workflow-siteName">Name:</label>
                    <input type="text" id="createSite-workflow-siteName" name="createSite-workflow-siteName">

                    <br>

                    Client Types:
                    <div>
                        <input type="checkbox" id="createSite-workflow-siteClientTypes-DSP" name="createSite-workflow-siteClientTypes[]" value="DSP">
                        <label for="createSite-workflow-siteClientTypes-DSP">DSP</label>
                    </div>
                    <div>
                        <input type="checkbox" id="createSite-workflow-siteClientTypes-ADVERTISER" name="createSite-workflow-siteClientTypes[]" value="ADVERTISER">
                        <label for="createSite-workflow-siteClientTypes-ADVERTISER">ADVERTISER</label>
                    </div>
                    <div>
                        <input type="checkbox" id="createSite-workflow-siteClientTypes-DATA_PROVIDER" name="createSite-workflow-siteClientTypes[]" value="DATA_PROVIDER">
                        <label for="createSite-workflow-siteClientTypes-DATA_PROVIDER">DATA_PROVIDER</label>
                    </div>
                    <div>
                        <input type="checkbox" id="createSite-workflow-siteClientTypes-PUBLISHER" name="createSite-workflow-siteClientTypes[]" value="PUBLISHER">
                        <label for="createSite-workflow-siteClientTypes-PUBLISHER">PUBLISHER</label>
                    </div>

                    <label for="createSite-workflow-siteDescription">Description (Optional):</label>
                    <input type="text" id="createSite-workflow-siteDescription" name="createSite-workflow-siteDescription">

                    <br>
                    <br>

                    <a href="#create" id="createSite-workflow-submit">Create</a>
                </div>

                <div id="updateSite-workflow" style="display: none">
                    <h3>Update an existing site</h3>

                    <label for="updateSite-workflow-siteId">Site ID:</label>
                    <input type="text" id="updateSite-workflow-siteId" name="updateSite-workflow-siteId">
                    <a href="#create" id="updateSite-workflow-search">Search</a>
                    <br>
                    <pre id="updateSite-workflow-searchOutput"></pre>

                    <br>

                    <div id="updateSite-workflow-afterSearch" style="display: none">
                        Name: <span id="updateSite-workflow-afterSearch-siteName"></span>

                        <br>

                        Client Types:
                        <div>
                            <input type="checkbox" id="updateSite-workflow-afterSearch-siteClientTypes-DSP" name="updateSite-workflow-afterSearch-siteClientTypes[]" value="DSP">
                            <label for="updateSite-workflow-afterSearch-siteClientTypes-DSP">DSP</label>
                        </div>
                        <div>
                            <input type="checkbox" id="updateSite-workflow-afterSearch-siteClientTypes-ADVERTISER" name="updateSite-workflow-afterSearch-siteClientTypes[]" value="ADVERTISER">
                            <label for="updateSite-workflow-afterSearch-siteClientTypes-ADVERTISER">ADVERTISER</label>
                        </div>
                        <div>
                            <input type="checkbox" id="updateSite-workflow-afterSearch-siteClientTypes-DATA_PROVIDER" name="updateSite-workflow-afterSearch-siteClientTypes[]" value="DATA_PROVIDER">
                            <label for="updateSite-workflow-afterSearch-siteClientTypes-DATA_PROVIDER">DATA_PROVIDER</label>
                        </div>
                        <div>
                            <input type="checkbox" id="updateSite-workflow-afterSearch-siteClientTypes-PUBLISHER" name="updateSite-workflow-afterSearch-siteClientTypes[]" value="PUBLISHER">
                            <label for="updateSite-workflow-afterSearch-siteClientTypes-PUBLISHER">PUBLISHER</label>
                        </div>

                        <label for="updateSite-workflow-afterSearch-siteDescription">Description (Optional):</label>
                        <input type="text" id="updateSite-workflow-afterSearch-siteDescription" name="updateSite-workflow-afterSearch-siteDescription">

                        <br>
                        <br>

                        <a href="#create" id="updateSite-workflow-submit">Update</a>
                    </div>
                </div>
            </td>
            <td>
                <h3>Operations</h3>
                <ul>
                    <li><a href="#create" id="createClient">Create client</a></li>
                </ul>

                <hr>

                <div id="createClient-workflow" style="display: none">
                    <h3>Create a new client</h3>

                    <label for="createClient-workflow-clientName">Name:</label>
                    <input type="text" id="createClient-workflow-clientName" name="createClient-workflow-clientName">

                    <br>

                    <label for="createClient-workflow-clientSiteId">Site ID:</label>
                    <input type="text" id="createClient-workflow-clientSiteId" name="createClient-workflow-clientSiteId">

                    <br>

                    Roles:
                    <select id="createClient-workflow-clientRoles">
                        <option value="" selected>Please select a role...</option>
                        <option value="GENERATOR">GENERATOR - for publishers</option>
                        <option value="MAPPER">MAPPER - for advertisers, data providers</option>
                        <option value="ID_READER">ID_READER - for DSPs</option>
                    </select>

                    <div>
                        <input type="checkbox" id="createClient-workflow-clientRoles-SHARER" name="createClient-workflow-clientRoles[]" value="SHARER">
                        <label for="createClient-workflow-clientRoles-SHARER">Does it additionally need the SHARER role? Be sure that the client definitely needs this. Most don't.</label>
                    </div>

                    <br>

                    <a href="#create" id="createClient-workflow-submit">Create</a>
                </div>
            </td>
        </tr>
    </table>
</div>

<script language="JavaScript">
    $(document).ready(() => {
        $("#searchParticipant").on("click", () => {
            const name = $("#participantName").val();

            search("site", name);
            search("client", name);
        });

        $("#createSite").on("click", () => {
            $("#createSite-workflow").show();
            $("#updateSite-workflow").hide();
        });

        $("#createSite-workflow-submit").on("click", () => {
            $("#siteSearchOutput").text("");

            const name = encodeURIComponent($("#createSite-workflow-siteName").val());
            const clientTypes = $("input[name='createSite-workflow-siteClientTypes[]']:checked").map((_, el) => encodeURIComponent($(el).val())).get().join(",");
            const description = encodeURIComponent($("#createSite-workflow-siteDescription").val());
            const url = `/api/site/add?name=${name}&types=${clientTypes}&description=${description}`;

            doApiCallWithCallback("POST", url, (text) => {
                const site = JSON.parse(text);

                const alertMessage = `Created site for [${site.name}] with site ID [${site.id}]`;

                const outputMessage = `\
${alertMessage}

--------------------------------------------------

${JSON.stringify(site, null, 2)}`;

                $("#siteSearchOutput").text(outputMessage);
                window.alert(alertMessage);
            }, (err) => standardErrorCallback(err, "#siteSearchOutput"));
        });

        $("#updateSite").on("click", () => {
            $("#createSite-workflow").hide();
            $("#updateSite-workflow").show();
        });

        $("#updateSite-workflow-search").on("click", () => {
            $("#updateSite-workflow-searchOutput").text("");
            $("#updateSite-workflow-afterSearch").hide();

            const siteId = encodeURIComponent($("#updateSite-workflow-siteId").val());

            doApiCallWithCallback("GET", "/api/site/list", (text) => {
                    const searchList = JSON.parse(text);

                    const siteList = searchList.filter(s => s.id.toString() === siteId);
                    if (siteList.length === 0) {
                        $("#updateSite-workflow-searchOutput").text("No results");
                    } else {
                        $("#updateSite-workflow-afterSearch").show();

                        const site = siteList[0];
                        $("#updateSite-workflow-afterSearch-siteName").text(site.name);
                        site.clientTypes.forEach((type) => {
                            $(`input[name="updateSite-workflow-afterSearch-siteClientTypes[]"][value="${type}"]`).prop("checked", true)
                        });
                        $("#updateSite-workflow-afterSearch-siteDescription").val(site.description);
                    }
                }, (err) => standardErrorCallback(err, "#updateSite-workflow-searchOutput"));
        });

        $("#updateSite-workflow-submit").on("click", () => {
            $("#siteSearchOutput").text("");

            const id = encodeURIComponent($("#updateSite-workflow-siteId").val());
            const name = $("#updateSite-workflow-afterSearch-siteName").text();
            const clientTypes = $("input[name='updateSite-workflow-afterSearch-siteClientTypes[]']:checked").map((_, el) => encodeURIComponent($(el).val())).get().join(",");
            const description = encodeURIComponent($("#updateSite-workflow-afterSearch-siteDescription").val());

            const updateClientTypesUrl = `/api/site/set-types?id=${id}&types=${clientTypes}`;
            const updateDescriptionUrl = `/api/site/update?id=${id}&description=${description}`;

            doApiCallWithCallback(
                "POST",
                updateClientTypesUrl,
                () => doApiCallWithCallback(
                    "POST",
                    updateDescriptionUrl,
                    () => search("site", name),
                    (err) => standardErrorCallback(err, "#siteSearchOutput")
                ),
                (err) => standardErrorCallback(err, "#siteSearchOutput")
            );
        });

        $("#createClient").on("click", () => {
            $("#createClient-workflow").show();
        });

        $("#createClient-workflow-submit").on("click", () => {
            const isSharerRoleChecked = $("#createClient-workflow-clientRoles-SHARER").is(":checked");
            if (isSharerRoleChecked && !confirm("Are you sure you want to create a client key with the SHARER role? This is difficult to reverse.")) {
                return;
            }

            $("#clientSearchOutput").text("");

            const name = encodeURIComponent($("#createClient-workflow-clientName").val());
            let roles = encodeURIComponent($("#createClient-workflow-clientRoles").val());
            if (isSharerRoleChecked) {
                roles += ",SHARER";
            }
            const siteId = encodeURIComponent($("#createClient-workflow-clientSiteId").val());
            const url = `/api/client/add?name=${name}&roles=${roles}&site_id=${siteId}&service_id=0`;

            doApiCallWithCallback("POST", url, (text) => {
                const client = JSON.parse(text);

                const alertMessage = `Created API key for [${client.authorizable.name}] under site ID [${client.authorizable.site_id}]`;

                const tradeSecretsMessage = `\
Key: ${client.plaintext_key}
Secret: ${client.authorizable.secret}`;

                const jiraBody = JSON.parse(JSON.stringify(client.authorizable));
                delete jiraBody.key_hash;
                delete jiraBody.key_salt;
                delete jiraBody.secret;
                delete jiraBody.key_id;

                const outputMessage = `\
${alertMessage}

--------------------------------------------------

Please copy the following into TradeSecrets:
${tradeSecretsMessage}

--------------------------------------------------

Please copy the following into JIRA:
${JSON.stringify(jiraBody, null, 2)}

--------------------------------------------------

${JSON.stringify(client, null, 2)}`;

                $("#clientSearchOutput").text(outputMessage);
                window.alert(alertMessage);
            }, (err) => standardErrorCallback(err, `#clientSearchOutput`));
        });

        const search = (type, name) => {
            $(`#${type}SearchOutput`).text("");

            doApiCallWithCallback("GET", `/api/${type}/list`, (text) => {
                    const searchList = JSON.parse(text);

                    const similarList = searchList.filter((s) => s.name.toLowerCase().includes(name.toLowerCase()));
                    if (similarList.length === 0) {
                        $(`#${type}SearchOutput`).text("No results");
                    } else {
                        $(`#${type}SearchOutput`).text(JSON.stringify(similarList, null, 2));
                    }
                }, (err) => standardErrorCallback(err, `#${type}SearchOutput`));
        }
    });
</script>

</body>
</html>
