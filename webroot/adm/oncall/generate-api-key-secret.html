<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="/js/main.js"></script>

    <style>
        table, th, td {
            border: 1px solid;
            vertical-align: top;
        }
    </style>
</head>
<body>
<h1>UID2 Env - On-call - Generate API Key/Secret</h1>

<a href="/">Back</a>

<br>
<br>

<div class="ro-adm" style="display: none">
    <h3>Please input the participant's name.</h3>
    <label for="participantName">Name:</label>
    <input type="text" id="participantName" name="participantName">
    <a href="#" id="searchParticipant">Search</a>

    <br>
    <br>

    <table id="searchTable">
        <tr>
            <th>Sites</th>
            <th>Clients</th>
        </tr>
        <tr>
            <td>
                <pre id="siteSearchOutput"></pre>
                <pre id="siteSearchErrorOutput"></pre>
            </td>
            <td>
                <pre id="clientSearchOutput"></pre>
                <pre id="clientSearchErrorOutput"></pre>
            </td>
        </tr>
        <tr>
            <td id="create" colspan="2" style="text-align: center">
                <h3>Didn't find what you were looking for?</h3>
            </td>
        </tr>
        <tr>
            <td>
                <label for="siteName">Name:</label>
                <input type="text" id="siteName" name="siteName">

                <br>

                Client Types:
                <div>
                    <input type="checkbox" id="siteClientTypes-DSP" name="siteClientTypes[]" value="DSP">
                    <label for="siteClientTypes-DSP">DSP</label>
                </div>
                <div>
                    <input type="checkbox" id="siteClientTypes-ADVERTISER" name="siteClientTypes[]" value="ADVERTISER">
                    <label for="siteClientTypes-ADVERTISER">ADVERTISER</label>
                </div>
                <div>
                    <input type="checkbox" id="siteClientTypes-DATA_PROVIDER" name="siteClientTypes[]" value="DATA_PROVIDER">
                    <label for="siteClientTypes-DATA_PROVIDER">DATA_PROVIDER</label>
                </div>
                <div>
                    <input type="checkbox" id="siteClientTypes-PUBLISHER" name="siteClientTypes[]" value="PUBLISHER">
                    <label for="siteClientTypes-PUBLISHER">PUBLISHER</label>
                </div>

                <label for="siteDescription">Description (Optional):</label>
                <input type="text" id="siteDescription" name="siteDescription">

                <br>
                <br>

                <a href="#create" id="createSite">Create site</a>
            </td>
            <td>
                <label for="clientName">Name:</label>
                <input type="text" id="clientName" name="clientName">

                <br>

                Roles:
                <div>
                    <input type="checkbox" id="clientRoles-GENERATOR" name="clientRoles[]" value="GENERATOR">
                    <label for="clientRoles-GENERATOR">GENERATOR - for publishers</label>
                </div>
                <div>
                    <input type="checkbox" id="clientRoles-MAPPER" name="clientRoles[]" value="MAPPER">
                    <label for="clientRoles-MAPPER">MAPPER - for advertisers, data providers</label>
                </div>
                <div>
                    <input type="checkbox" id="clientRoles-ID_READER" name="clientRoles[]" value="ID_READER">
                    <label for="clientRoles-ID_READER">ID_READER - for DSPs</label>
                </div>
                <div>
                    <input type="checkbox" id="clientRoles-SHARER" name="clientRoles[]" value="SHARER">
                    <label for="clientRoles-SHARER">SHARER</label>
                </div>

                <label for="clientSiteId">Site ID:</label>
                <input type="text" id="clientSiteId" name="clientSiteId">

                <br>
                <br>

                <a href="#create" id="createClient">Create client</a>
            </td>
        </tr>
    </table>
</div>

<script language="JavaScript">
    $(document).ready(() => {
        $("#searchParticipant").on("click", () => {
            const name = encodeURIComponent($("#participantName").val());

            $.when(
                search("site", name),
                search("client", name)
            )
            .then((r1, r2) => {});
        });

        $("#createSite").on("click", () => {
            $(`#siteSearchOutput`).text("");
            $(`#siteSearchErrorOutput`).text("");

            const name = encodeURIComponent($("#siteName").val());
            const clientTypes = $("input[name='siteClientTypes[]']:checked").map((_, el) => encodeURIComponent($(el).val())).get().join(",");
            const description = encodeURIComponent($("#siteDescription").val());
            const url = "/api/site/add?name=" + name + "&types=" + clientTypes + "&description=" + description;

            doApiCallWithCallback("POST", url, (text) => {
                $("#siteSearchOutput").text(JSON.stringify(JSON.parse(text), null, 2));
                window.alert(`Created site for [${name}]`);
            }, (err) => standardErrorCallback(err, `#siteSearchErrorOutput`));
        });

        $("#createClient").on("click", () => {
            $(`#clientSearchOutput`).text("");
            $(`#clientSearchErrorOutput`).text("");

            const name = encodeURIComponent($("#clientName").val());
            const roles = $("input[name='clientRoles[]']:checked").map((_, el) => encodeURIComponent($(el).val())).get().join(",");
            const siteId = encodeURIComponent($("#clientSiteId").val());
            const url = "/api/client/add?name=" + name + "&roles=" + roles + "&site_id=" + siteId + "&service_id=0";

            doApiCallWithCallback("POST", url, (text) => {
                $("#clientSearchOutput").text(JSON.stringify(JSON.parse(text), null, 2));
                window.alert(`Created API key for [${decodeURIComponent(name)}] under site ID [${siteId}]`);
            }, (err) => standardErrorCallback(err, `#clientSearchErrorOutput`));
        });

        const search = (type, name) => {
            $(`#${type}SearchOutput`).text("");
            $(`#${type}SearchErrorOutput`).text("");

            doApiCallWithCallback("GET", `/api/${type}/list`, (text) => {
                    const searchList = JSON.parse(text);

                    similarList = searchList.filter(s => s.name.toLowerCase().includes(name.toLowerCase()));
                    if (similarList.length === 0) {
                        $(`#${type}SearchOutput`).text("No results");
                    } else {
                        $(`#${type}SearchOutput`).text(JSON.stringify(similarList, null, 2));
                    }
                }, (err) => standardErrorCallback(err, `#${type}SearchErrorOutput`));
        }
    });
</script>

</body>
</html>
