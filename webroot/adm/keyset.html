<html>
<head>
  <meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
  <script type="module" src="/js/dangerModal.js"></script>
  <script type="module" src="/js/operations.js"></script>
  <script type="module" src="/js/output.js"></script>
  <script type="module" src="/js/roleBadge.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<h1>UID2 Env - Keyset Access Management</h1>

<a href="/">Back</a>

<div class="main-content">
  <div class="operations-container"></div>
  <div class="output-container"></div>
</div>

<script type="module">
import { initializeOperations } from '/js/operations.js';
import { initializeOutput } from '/js/output.js';
import { httpClient } from '/js/httpClient.js';

document.addEventListener('DOMContentLoaded', function () {
  const operationConfig = [
    {
      type: 'read-only',
      title: 'Read Only Operations',
      operations: [
        {
          id: 'doListAll',
          title: 'List All Keysets',
          role: 'maintainer',
          inputs: [],
          apiCall: {
            method: 'GET',
            url: '/api/sharing/keysets'
          }
        },
        {
          id: 'doListAllBySite',
          title: 'List All Keysets By Site Id',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-listBySite',
              name: 'siteId',
              label: 'Site Id',
              required: true
            }
          ],
          apiCall: {
            method: 'GET',
            url: '/api/sharing/keysets'
          },
          postProcess: (responseData, inputs) => responseData.filter(keyset => keyset.site_id === parseInt(inputs.siteId))
        },
        {
          id: 'doShowKeysetById',
          title: 'Show Keyset By Keyset Id',
          role: 'maintainer',
          inputs: [
            {
              id: 'keysetId-show',
              name: 'keysetId',
              label: 'Keyset Id',
              required: true
            }
          ],
          apiCall: {
            method: 'GET',
            getUrl: (inputs) => `/api/sharing/keyset/${parseInt(inputs.keysetId)}`
          }
        }
      ]
    },
    {
      type: 'write',
      title: 'Write Operations',
      operations: [
        {
          id: 'doUpdate',
          title: 'Update Keyset',
          role: 'maintainer',
          inputs: [
            {
              id: 'keysetId-update',
              name: 'keysetId',
              label: 'Keyset Id',
              required: true
            },
            {
              id: 'keysetName-update',
              name: 'keysetName',
              label: 'Set Keyset Name'
            },
            {
              id: 'addSiteIds-update',
              name: 'addSiteIds',
              label: 'Add Allowed Sites'
            },
            {
              id: 'removeSiteIds-update',
              name: 'removeSiteIds',
              label: 'Remove Allowed Sites'
            },
            {
              id: 'addTypes-update',
              name: 'addTypes',
              label: 'Add Allowed Types'
            },
            {
              id: 'removeTypes-update',
              name: 'removeTypes',
              label: 'Remove Allowed Types'
            }
          ],
          preProcess: async (inputs) => {
            const keysetId = parseInt(inputs.keysetId);
            
            const currentKeyset = await httpClient.get(`/api/sharing/keyset/${keysetId}`);
            
            let allowedSites = currentKeyset.allowed_sites;
            let allowedTypes = currentKeyset.allowed_types;
            
            const add = (inputs.addSiteIds || '').replace(/\s+/g, '').split(',').filter(value => value !== "").map(Number);
            const remove = (inputs.removeSiteIds || '').replace(/\s+/g, '').split(',').filter(value => value !== "").map(Number);
            
            if ((add && add.length !== 0) || (remove && remove.length !== 0)) {
              if (allowedSites == null) {
                throw new Error('cannot add/remove sites from null. If this was intentional, please reset allowed_sites to empty then try again.');
              }
              allowedSites = allowedSites.filter(value => !remove.includes(value));
              allowedSites = allowedSites.concat(add.filter(value => !allowedSites.includes(value)));
            }
            
            const addTypes = (inputs.addTypes || '').replace(/\s+/g, '').split(',').filter(value => value !== "").map(String);
            const removeTypes = (inputs.removeTypes || '').replace(/\s+/g, '').split(',').filter(value => value !== "").map(String);
            
            if ((addTypes && addTypes.length !== 0) || (removeTypes && removeTypes.length !== 0)) {
              if (allowedTypes == null) {
                throw new Error('cannot add/remove types from null. If this was intentional, please reset allowed_sites to empty then try again.');
              }
              allowedTypes = allowedTypes.filter(value => !removeTypes.includes(value));
              allowedTypes = allowedTypes.concat(addTypes.filter(value => !allowedTypes.includes(value)));
            }
            
            let payload = {keyset_id: keysetId, allowed_sites: allowedSites, allowed_types: allowedTypes};
            
            let name = inputs.keysetName;
            if (name && (name = name.trim())) {
              payload.name = name;
            }
            
            return {...inputs, payload};
          },
          apiCall: {
            method: 'POST',
            url: '/api/sharing/keyset',
            getPayload: (inputs) => inputs.payload
          }
        },
        {
          id: 'doMakeNew',
          title: 'Make New Keyset',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-new',
              name: 'siteId',
              label: 'Site Id',
              required: true
            },
            {
              id: 'keysetName-new',
              name: 'keysetName',
              label: 'Set Keyset Name'
            },
            {
              id: 'addSiteIds-new',
              name: 'addSiteIds',
              label: 'Add Allowed Sites'
            },
            {
              id: 'addTypes-new',
              name: 'addTypes',
              label: 'Add Allowed Types'
            }
          ],
          apiCall: {
            method: 'POST',
            url: '/api/sharing/keyset',
            getPayload: (inputs) => {
              const siteId = parseInt(inputs.siteId);
              let payload = {site_id: siteId};
              
              let name = inputs.keysetName;
              if (name && (name = name.trim())) {
                payload.name = name;
              }
              
              let allowedSites = [];
              const add = (inputs.addSiteIds || '').replace(/\s+/g, '').split(',').filter(value => value !== "").map(Number);
              const addTypes = (inputs.addTypes || '').replace(/\s+/g, '').split(',').filter(value => value !== "").map(String);
              
              if (add && add.length !== 0) {
                allowedSites = allowedSites.concat(add.filter(value => !allowedSites.includes(value)));
              }
              
              payload.allowed_sites = allowedSites;
              payload.allowed_types = addTypes;
              
              return payload;
            }
          }
        }
      ]
    },
    {
      type: 'danger-zone',
      title: '☠️ Danger Zone ☠️',
      operations: [
        {
          id: 'doResetEmpty',
          title: 'Reset Allowed Sites To Empty',
          role: 'maintainer',
          inputs: [
            {
              id: 'keysetId-resetEmpty',
              name: 'keysetId',
              label: 'Keyset Id',
              required: true
            }
          ],
          apiCall: {
            method: 'POST',
            url: '/api/sharing/keyset',
            getPayload: (inputs) => ({
              allowed_sites: [],
              keyset_id: parseInt(inputs.keysetId)
            })
          }
        },
        {
          id: 'doResetNull',
          title: 'Reset Allowed Sites To Null',
          role: 'maintainer',
          inputs: [
            {
              id: 'keysetId-resetNull',
              name: 'keysetId',
              label: 'Keyset Id',
              required: true
            }
          ],
          apiCall: {
            method: 'POST',
            url: '/api/sharing/keyset',
            getPayload: (inputs) => ({
              allowed_sites: null,
              keyset_id: parseInt(inputs.keysetId)
            })
          }
        }
      ]
    }
  ];

  initializeOperations(operationConfig);
  initializeOutput();
});
</script>

</body>
</html>
