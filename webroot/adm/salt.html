<html>
<head>
  <meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<h1>UID2 Env - Salt Management</h1>

<a href="/">Back</a>

<div class="main-content">
  <div class="operations-container"></div>
  <div class="output-container"></div>
</div>

<script type="module">
import { initializeOperations } from '/js/component/operations.js';
import { initializeOutput } from '/js/component/output.js';

document.addEventListener('DOMContentLoaded', function () {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const defaultTargetDate = tomorrow.getFullYear() + '-' +
      String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' +
      String(tomorrow.getDate()).padStart(2, '0');

  const fractionInput = {
    name: 'fraction',
    label: 'Fraction',
    required: true,
    defaultValue: (1/365).toFixed(6)
  };

  const targetDateInput = {
    name: 'targetDate',
    label: 'Target Date',
    type: 'date',
    required: true,
    defaultValue: defaultTargetDate
  };

  const fastForwardIterationsInput = {
    name: 'fastForwardIterations',
    label: 'Iterations',
    required: true,
    type: 'number',
    defaultValue: 0
  };

  const fastForwardWithV4Input = {
    name: 'fastForwardWithV4',
    label: 'Enable V4',
    type: 'checkbox',
    defaultValue: true
  }

  const referenceOperatorUrlInput = {
    name: 'referenceOperatorUrl',
    label: 'Reference Operator URL'
  }

  const referenceApiKeyInput = {
    name: 'referenceApiKey',
    label: 'Reference API Key'
  }

  const referenceApiSecretInput = {
    name: 'referenceApiSecret',
    label: 'Reference API Secret'
  }

  const candidateOperatorUrlInput = {
    name: 'candidateOperatorUrl',
    label: 'Candidate Operator URL'
  }

  const candidateApiKeyInput = {
    name: 'candidateApiKey',
    label: 'Candidate API Key'
  }

  const candidateApiSecretInput = {
    name: 'candidateApiSecret',
    label: 'Candidate API Secret'
  }

  const tokenIterationsInput = {
    name: 'tokenIterations',
    label: 'Iterations',
    required: true,
    type: 'number',
    defaultValue: 0
  };

  const tokenWithV4Input = {
    name: 'tokenWithV4',
    label: 'Enable V4',
    type: 'checkbox',
    defaultValue: true
  }

  const preMigrationIterationsInput = {
    name: 'preMigrationIterations',
    label: 'Step 1 - Pre-Migration Iterations',
    required: true,
    type: 'number',
    defaultValue: 0
  };

  const migrationV4IterationsInput = {
    name: 'migrationV4Iterations',
    label: 'Step 2 - Migration Iterations with V4 flag on',
    required: true,
    type: 'number',
    defaultValue: 0
  };

  const migrationV2IterationsInput = {
    name: 'migrationV2Iterations',
    label: 'Step 3 - Migration Iterations with V4 flag off',
    required: true,
    type: 'number',
    defaultValue: 0
  };

  const operationConfig = {
    read: [
      {
        id: 'listSaltSnapshots',
        title: 'List Salt Snapshots',
        role: 'maintainer',
        inputs: [],
        apiCall: {
          method: 'GET',
          url: '/api/salt/snapshots'
        }
      }
    ],
    write: [
      {
        id: 'rebuildSaltsFile',
        title: 'Rebuild Salts File',
        role: 'maintainer',
        inputs: [],
        apiCall: {
          method: 'POST',
          url: '/api/salt/rebuild'
        }
      },
      {
        id: 'fastForwardSalts',
        title: 'Fast Forward Salts',
        role: 'maintainer',
        inputs: [
          fractionInput,
          targetDateInput,
          fastForwardIterationsInput,
          fastForwardWithV4Input
        ],
        apiCall: {
          method: 'POST',
          getUrl: (inputs) => {
            const fraction = encodeURIComponent(inputs.fraction);
            const targetDate = encodeURIComponent(inputs.targetDate);
            const iterations = encodeURIComponent(inputs.fastForwardIterations);
            const enableV4 = encodeURIComponent(inputs.fastForwardWithV4 || false);
            return `/api/salt/fastForward?fraction=${fraction}&target_date=${targetDate}&fast_forward_iterations=${iterations}&enable_v4=${enableV4}`;
          }
        },
      },
      {
        id: 'benchmark',
        title: 'Benchmark Identity Map V3',
        role: 'maintainer',
        inputs: [
          candidateOperatorUrlInput,
          candidateApiKeyInput,
          candidateApiSecretInput
        ],
        apiCall: {
          method: 'POST',
          getUrl: (inputs) => {
            const candidateOperatorUrl = encodeURIComponent(inputs.candidateOperatorUrl);
            const candidateApiKey = encodeURIComponent(inputs.candidateApiKey);
            const candidateApiSecret = encodeURIComponent(inputs.candidateApiSecret);
            return `/api/salt/benchmark?candidate_operator_url=${candidateOperatorUrl}&candidate_api_key=${candidateApiKey}&candidate_api_secret=${candidateApiSecret}`;
          }
        },
      },
      {
        id: 'compare',
        title: 'Compare Operator Raw UIDs',
        role: 'maintainer',
        inputs: [
          referenceOperatorUrlInput,
          referenceApiKeyInput,
          referenceApiSecretInput,
          candidateOperatorUrlInput,
          candidateApiKeyInput,
          candidateApiSecretInput
        ],
        apiCall: {
          method: 'POST',
          getUrl: (inputs) => {
            const referenceOperatorUrl = encodeURIComponent(inputs.referenceOperatorUrl);
            const referenceApiKey = encodeURIComponent(inputs.referenceApiKey);
            const referenceApiSecret = encodeURIComponent(inputs.referenceApiSecret);
            const candidateOperatorUrl = encodeURIComponent(inputs.candidateOperatorUrl);
            const candidateApiKey = encodeURIComponent(inputs.candidateApiKey);
            const candidateApiSecret = encodeURIComponent(inputs.candidateApiSecret);
            return `/api/salt/compare?reference_operator_url=${referenceOperatorUrl}&reference_api_key=${referenceApiKey}&reference_api_secret=${referenceApiSecret}&candidate_operator_url=${candidateOperatorUrl}&candidate_api_key=${candidateApiKey}&candidate_api_secret=${candidateApiSecret}`;
          }
        },
      },
      {
        id: 'simulateToken',
        title: 'Simulate Token',
        role: 'maintainer',
        inputs: [
          fractionInput,
          targetDateInput,
          tokenIterationsInput,
          tokenWithV4Input
        ],
        apiCall: {
          method: 'POST',
          getUrl: (inputs) => {
            const fraction = encodeURIComponent(inputs.fraction);
            const targetDate = encodeURIComponent(inputs.targetDate);
            const iterations = encodeURIComponent(inputs.tokenIterations);
            const enableV4 = encodeURIComponent(inputs.tokenWithV4 || false);
            return `/api/salt/simulateToken?fraction=${fraction}&target_date=${targetDate}&iterations=${iterations}&enable_v4=${enableV4}`;
          }
        },
      },
      {
        id: 'simulateRotation',
        title: 'Simulate Rotation',
        role: 'maintainer',
        inputs: [
          fractionInput,
          targetDateInput,
          preMigrationIterationsInput,
          migrationV4IterationsInput,
          migrationV2IterationsInput
        ],
        apiCall: {
          method: 'POST',
          getUrl: (inputs) => {
            const fraction = encodeURIComponent(inputs.fraction);
            const targetDate = encodeURIComponent(inputs.targetDate);
            const preMigrationIterations = encodeURIComponent(inputs.preMigrationIterations);
            const migrationV4Iterations = encodeURIComponent(inputs.migrationV4Iterations);
            const migrationV2Iterations = encodeURIComponent(inputs.migrationV2Iterations);
            return `/api/salt/simulate?fraction=${fraction}&target_date=${targetDate}&pre_migration_iterations=${preMigrationIterations}&migration_v4_iterations=${migrationV4Iterations}&migration_v2_iterations=${migrationV2Iterations}`;
          }
        }
      }
    ],
    danger: [
      {
        id: 'rotateSecondLevelSalts',
        title: 'Rotate Second Level Salts',
        role: 'superuser',
        inputs: [
          fractionInput,
          targetDateInput
        ],
        apiCall: {
          method: 'POST',
          getUrl: (inputs) => {
            const fraction = encodeURIComponent(inputs.fraction);
            const targetDate = encodeURIComponent(inputs.targetDate);
            return `/api/salt/rotate?fraction=${fraction}&target_date=${targetDate}`;
          }
        }
      }
    ]
  };

  initializeOperations(operationConfig);
  initializeOutput();

});
</script>

</body>
</html>
