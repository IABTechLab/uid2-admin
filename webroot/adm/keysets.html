<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
</head>
<body>
<h1>UID2 Admin - Keyset Access Management</h1>

<a href="/">Back</a>

<br>
<br>

<h3>Inputs</h3>
<div>
  <label for="keysetId">Keyset Id:</label>
  <input type="text" id="keysetId" name="keysetId">
  <label for="siteId">Site Id:</label>
  <input type="text" id="siteId" name="siteId">
</div>
<br>
<div>
  <label for="keysetName">Set Keyset Name:</label>
  <input type="text" id="keysetName" name="keysetName">
  <label for="addSiteIds">Add Allowed Sites:</label>
  <input type="text" id="addSiteIds" name="addSiteIds">
  <label for="removeSiteIds">Remove Allowed Sites:</label>
  <input type="text" id="removeSiteIds" name="removeSiteIds">
  <label for="nullify">Set allowed_sites to *:</label>
  <input type="checkbox" id="nullify" name="nullify" value="true">
</div>

<br>
<br>

<h3>Operations</h3>

<ul>
  <li class="ro-adm" style="display: none"><a href="#" id="doListAll">List All Keysets</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doListAllBySite">List All Keysets By Site Id</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doShowKeysetById">Show Keyset By Keyset Id</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doReset">Reset Keyset</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doUpdate">Update Keyset</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doMakeNew">Make New Keyset</a></li>
</ul>

<br>

<h3>Output</h3>

<div id="output">
  <pre id="errorOutput"></pre>
  <pre id="standardOutput"></pre>
</div>

<script language="JavaScript">
  $(document).ready(function () {
    $('#doListAll').on('click', function () {
      doApiCall('GET', '/api/sharing/keysets', '#standardOutput', '#errorOutput');
    });

    $('#doListAllBySite').on('click', function () {
      const siteId = parseInt($('#siteId').val());
      if(!siteId) {
        $('#errorOutput').html("Required Parameters: site_id")
        return;
      }
      const url = '/api/sharing/keysets';

      doApiCallWithCallback('GET', url, (text) => {
        const ja = JSON.parse(text);

        const filtered = ja.filter(function(keyset) {
          return keyset.site_id === siteId
        });
        filtered.forEach( obj => {
          if(obj['allowed_sites'] !== undefined && obj['allowed_sites'] == null){
            obj['allowed_sites'] = '*'
          }
        })
        const pretty = JSON.stringify(filtered,null,2);
        $('#standardOutput').html(pretty);

      }, (err) => {
        $('#errorOutput').html('Error: ' + err.status + ': ' + err.statusText);
      });
    });

    $('#doShowKeysetById').on('click', function () {
      const keysetId = parseInt($('#keysetId').val());
      if(!keysetId) {
        $('#errorOutput').html("Required Parameters: keyset_id")
        return;
      }
      doApiCall('GET', '/api/sharing/keyset/' + keysetId, '#standardOutput', '#errorOutput');
    });

    $('#doReset').on('click', function () {
      const keysetId = parseInt($('#keysetId').val());
      if(!keysetId) {
        $('#errorOutput').html("Required Parameters: keyset_id")
        return;
      }
      const url = '/api/sharing/keyset';
      doApiCall('POST', url, '#standardOutput', '#errorOutput', JSON.stringify({allowed_sites: [], keyset_id : keysetId}))
    });

    $('#doUpdate').on('click', function () {
      const keysetId = parseInt($('#keysetId').val());
      if(!keysetId) {
        $('#errorOutput').html("Required Parameters: keyset_id")
        return;
      }
      let name = $('#keysetName').val();
      const url = '/api/sharing/keyset/' + keysetId.toString();

      const add = ($('#addSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);
      const remove = ($('#removeSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);

      doApiCallWithCallback('GET', url, (text) => {
        const jo = JSON.parse(text);
        let allowedSites = jo.allowed_sites;

        const url = '/api/sharing/keyset';

        let payload = {keyset_id: keysetId}

        if ($('#nullify').is(':checked')){
          allowedSites = null
        } else if((add && add.length !== 0) || (remove && remove.length !== 0)) {
          if(allowedSites !== undefined && allowedSites == null) {
            $('#errorOutput').html('cannot modify siteIds for allow * keyset. Please reset first')
          }
          allowedSites = allowedSites.filter((value, _, __) => !remove.includes(value))
          allowedSites = allowedSites.concat(add.filter((value, _, __) => !allowedSites.includes(value)))
        }

        payload["allowed_sites"] = allowedSites

        if(name && (name = $.trim(name))) {
          payload["name"] = name
        }

        doApiCall('POST', url, '#standardOutput', '#errorOutput', JSON.stringify(payload))
      }, (err) => {
        $('#errorOutput').html('Error: ' + err.status + ': ' + (isJsonString(err.responseText) ? JSON.parse(err.responseText).message : (err.responseText ? err.responseText : err.statusText)));
      });

    });
    $('#doMakeNew').on('click', function () {
      const siteId = parseInt($('#siteId').val());
      if(!siteId) {
        $('#errorOutput').html("Required Parameters: site_id")
        return;
      }
      let name = $('#keysetName').val();
      const url = '/api/sharing/keyset';

      let payload = {site_id: siteId}
      if(name && (name = $.trim(name))) {
        payload['name'] = name
      }

      let allowedSites = []
      const add = ($('#addSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);
      if ($('#nullify').is(':checked')){
        allowedSites = null
      } else if(add && add.length !== 0) {
        allowedSites = allowedSites.concat(add.filter((value, _, __) => !allowedSites.includes(value)))
      }
      payload['allowed_sites'] = allowedSites

      doApiCall('POST', url, '#standardOutput', '#errorOutput', JSON.stringify(payload));
    });
  });

</script>

</body>
</html>
