<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
</head>
<body>
<h1>UID2 Admin - Keyset Access Management</h1>

<a href="/">Back</a>

<br>
<br>

<h3>Inputs</h3>

<label for="siteId">Site Id:</label>
<input type="text" id="siteId" name="siteId">
<label for="keysetId">Keyset Id:</label>
<input type="text" id="keysetId" name="keysetId">
<label for="keysetName">Set Keyset Name:</label>
<input type="text" id="keysetName" name="keysetName">
<label for="addSiteIds">Add Site Ids:</label>
<input type="text" id="addSiteIds" name="addSiteIds">
<label for="removeSiteIds">Remove Site Ids:</label>
<input type="text" id="removeSiteIds" name="removeSiteIds">

<br>
<br>

<h3>Operations</h3>

<ul>
  <li class="ro-adm" style="display: none"><a href="#" id="doListAll">List All Keysets</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doListAllBySite">List All Keysets By Site Id</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doShowKeysetById">Show Keyset By Keyset Id</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doReset">Reset Keyset</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doUpdate">Update Keyset</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doMakeNew">Make New Keyset</a></li>
</ul>

<br>

<h3>Output</h3>

<div id="output">
  <pre id="errorOutput"></pre>
  <pre id="standardOutput"></pre>
</div>

<script language="JavaScript">
  $(document).ready(function () {
    $('#doListAll').on('click', function () {
      doApiCall('GET', '/api/sharing/keysets', '#standardOutput', '#errorOutput');
    });

    $('#doListAllBySite').on('click', function () {
      const siteId = parseInt($('#siteId').val());
      if(!siteId) {
        $('#errorOutput').html("Required Parameters: site_id")
        return;
      }
      const url = '/api/sharing/keysets';

      doApiCallWithCallback('GET', url, (text) => {
        const ja = JSON.parse(text);

        const filtered = ja.filter(function(keyset) {
          return keyset.site_id === siteId
        });
        const pretty = JSON.stringify(filtered,null,2);
        $('#standardOutput').html(pretty);

      }, (err) => {
        $('#errorOutput').html('Error: ' + err.status + ': ' + err.statusText);
      });
    });

    $('#doShowKeysetById').on('click', function () {
      const keysetId = parseInt($('#keysetId').val());
      if(!keysetId) {
        $('#errorOutput').html("Required Parameters: keyset_id")
        return;
      }
      doApiCall('GET', '/api/sharing/keyset/' + keysetId, '#standardOutput', '#errorOutput');
    });

    $('#doReset').on('click', function () {
      const keysetId = parseInt($('#keysetId').val());
      if(!keysetId) {
        $('#errorOutput').html("Required Parameters: keyset_id")
        return;
      }
      const url = '/api/sharing/keyset';
      doApiCall('POST', url, '#standardOutput', '#errorOutput', JSON.stringify({allowlist: [], keyset_id : keysetId}))
    });

    $('#doUpdate').on('click', function () {
      const keysetId = parseInt($('#keysetId').val());
      if(!keysetId) {
        $('#errorOutput').html("Required Parameters: keyset_id")
        return;
      }
      let name = $('#keysetName').val();
      const url = '/api/sharing/keyset/' + keysetId.toString();

      const add = ($('#addSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);
      const remove = ($('#removeSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);

      doApiCallWithCallback('GET', url, (text) => {
        const jo = JSON.parse(text);
        let allowlist = jo.allowlist;

        const url = '/api/sharing/keyset';

        let payload = {keyset_id: keysetId}

        if((add && add.length !== 0) || (remove && remove.length !== 0)) {
          allowlist = allowlist.filter((value, _, __) => !remove.includes(value))
          allowlist = allowlist.concat(add.filter((value, _, __) => !allowlist.includes(value)))
        }

        payload["allowlist"] = allowlist

        if(name && (name = $.trim(name))) {
          payload["name"] = name
        }

        doApiCall('POST', url, '#standardOutput', '#errorOutput', JSON.stringify(payload))
      }, (err) => {
        $('#errorOutput').html('Error: ' + err.status + ': ' + (isJsonString(err.responseText) ? JSON.parse(err.responseText).message : (err.responseText ? err.responseText : err.statusText)));
      });

    });
    $('#doMakeNew').on('click', function () {
      const siteId = parseInt($('#siteId').val());
      if(!siteId) {
        $('#errorOutput').html("Required Parameters: site_id")
        return;
      }
      let name = $('#keysetName').val();
      const url = '/api/sharing/keyset';

      let payload;
      if(name && (name = $.trim(name))) {
        payload = JSON.stringify({allowlist: [], site_id: siteId, name: name})
      } else {
        payload = JSON.stringify({allowlist: [], site_id: siteId})
      }

      doApiCall('POST', url, '#standardOutput', '#errorOutput', payload);
    });
  });

</script>

</body>
</html>
