<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
</head>
<body>
<h1>UID2 Admin - Keyset Access Management</h1>

<a href="/">Back</a>

<br>
<br>

<h3>Inputs</h3>

<label for="siteId">Site Id:</label>
<input type="text" id="siteId" name="siteId">
<label for="keysetId">Keyset Id:</label>
<input type="text" id="keysetId" name="keysetId">
<label for="addSiteIds">Add Allowed Site Ids:</label>
<input type="text" id="addSiteIds" name="addSiteIds">
<label for="removeSiteIds">Remove Allowed Site Ids:</label>
<input type="text" id="removeSiteIds" name="removeSiteIds">

<br>
<br>

<h3>Operations</h3>

<ul>
  <li class="ro-adm" style="display: none"><a href="#" id="doListAll">List All</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doList">List</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doReset">Reset</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doUpdate">Update</a></li>
  <li class="ro-adm" style="display: none"><a href="#" id="doMakeNew">Make New Keyset</a></li>
</ul>

<br>

<h3>Output</h3>

<div id="output">
  <pre id="errorOutput"></pre>
  <pre id="standardOutput"></pre>
</div>

<script language="JavaScript">
  $(document).ready(function () {
    $('#doListAll').on('click', function () {
      doApiCall('GET', '/api/sharing/keysets', '#standardOutput', '#errorOutput');
    });

    $('#doList').on('click', function () {
      var keysetId = encodeURIComponent($('#keysetId').val());
      doApiCall('GET', '/api/sharing/keyset/' + keysetId, '#standardOutput', '#errorOutput');
    });

    $('#doReset').on('click', function () {
      const siteId = parseInt($('#siteId').val());
      const keysetId = parseInt($('#keysetId').val());
      if(isNaN(keysetId)) {
        $("#standardOutput").html("Enter a keyset id");
        return
      }
      const url = '/api/sharing/keyset';
      doApiCall('POST', url, '#standardOutput', 'errorOutput', JSON.stringify({allowed_sites: [], keyset_id : keysetId, site_id: siteId}))
    });

    $('#doUpdate').on('click', function () {
      const siteId = parseInt($('#siteId').val());
      const keysetId = parseInt($('#keysetId').val());
      const url = '/api/sharing/keyset/' + keysetId.toString();

      const add = ($('#addSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);
      const remove = ($('#removeSiteIds').val()).replace(/\s+/g, '').split(',').filter( (value, _, __) => value !== "").map(Number);

      doApiCallWithCallback('GET', url, (text) => {
        const jo = JSON.parse(text);
        let allowedSites = jo.allowed_sites;

        allowedSites = allowedSites.filter((value, _, __) => !remove.includes(value))
        allowedSites = allowedSites.concat(add.filter((value, _, __) => !allowedSites.includes(value)))

        const url = '/api/sharing/keyset';


        doApiCall('POST', url, '#standardOutput', 'errorOutput', JSON.stringify({allowed_sites: allowedSites, keyset_id: keysetId, site_id: siteId}))
      }, (err) => {
        $('#errorOutput').html('Error: ' + err.status + ': ' + err.statusText);
      });

    });
    $('#doMakeNew').on('click', function () {
      const siteId = parseInt($('#siteId').val());
      const url = '/api/sharing/keyset';
      doApiCall('POST', url, '#standardOutput', 'errorOutput', JSON.stringify({allowed_sites: [] ,site_id: siteId}));
    });
  });

</script>

</body>
</html>
