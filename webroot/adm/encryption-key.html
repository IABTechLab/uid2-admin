<html>
<head>
  <meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/js/main.js"></script>
  <script type="module" src="/js/dangerModal.js"></script>
  <script type="module" src="/js/operations.js"></script>
  <script type="module" src="/js/output.js"></script>
  <script type="module" src="/js/roleBadge.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<h1>UID2 Env - Encryption Key Management</h1>

<a href="/">Back</a>

<div class="main-content">
  <div class="operations-container"></div>
  <div class="output-container"></div>
</div>

<script type="module">
import { initializeOperations } from '/js/operations.js';
import { initializeOutput } from '/js/output.js';

document.addEventListener('DOMContentLoaded', function () {
  const operationConfig = [
    {
      type: 'read-only',
      title: 'Read Only Operations',
      operations: [
        {
          id: 'doListKeys',
          title: 'List Keys',
          role: 'maintainer',
          inputs: [],
          apiCall: {
            method: 'GET',
            url: '/api/key/list'
          },
          postProcess: (response) => response.sort((a, b) => a.id - b.id)
        },
        {
          id: 'doListKeysBySite',
          title: 'List Keys By Site',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-listBySite',
              name: 'siteId',
              label: 'Site ID',
              required: true,
              size: 1,
              type: 'number'
            }
          ],
          apiCall: {
            method: 'GET',
            url: '/api/key/list'
          },
          postProcess: (response, inputs) => {
            const siteId = parseInt(inputs.siteId);
            const filtered = response.filter(key => key.site_id === siteId);
            return filtered.sort((a, b) => a.id - b.id);
          }
        },
        {
          id: 'doListKeysetKeys',
          title: 'List Keyset Keys',
          role: 'maintainer',
          inputs: [],
          apiCall: {
            method: 'GET',
            url: '/api/key/list_keyset_keys'
          },
          postProcess: (response) => response.sort((a, b) => a.id - b.id)
        },
        {
          id: 'doListKeysetKeysByKeysetId',
          title: 'List Keyset Keys By Keyset ID',
          role: 'maintainer',
          inputs: [
            {
              id: 'keysetId-listByKeyset',
              name: 'keysetId',
              label: 'Keyset ID',
              required: true,
              size: 1,
              type: 'number'
            }
          ],
          apiCall: {
            method: 'GET',
            url: '/api/key/list_keyset_keys'
          },
          postProcess: (response, inputs) => {
            const keysetId = parseInt(inputs.keysetId);
            const filtered = response.filter(key => key.keyset_id === keysetId);
            return filtered.sort((a, b) => a.id - b.id);
          }
        }
      ]
    },
    {
      type: 'write',
      title: 'Write Operations',
      operations: [
        {
          id: 'doAddSiteKey',
          title: 'Add Site Key',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-add',
              name: 'siteId',
              label: 'Site ID',
              required: true,
              size: 1,
              type: 'number'
            },
            {
              id: 'activatesIn-add',
              name: 'activatesIn',
              label: 'Activates In (seconds)',
              required: true,
              size: 1,
              type: 'number'
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => `/api/key/add?site_id=${inputs.siteId}&activates_in_seconds=${inputs.activatesIn}`
          }
        },
        {
          id: 'doRotateSite',
          title: 'Rotate Site Key',
          role: 'maintainer',
          inputs: [
            {
              id: 'siteId-rotate',
              name: 'siteId',
              label: 'Site ID',
              required: true,
              size: 1,
              type: 'number'
            },
            {
              id: 'minAge-rotate',
              name: 'minAge',
              label: 'Min Age (seconds)',
              required: false,
              size: 1,
              type: 'number'
            },
            {
              id: 'force-rotate',
              name: 'force',
              label: 'Force',
              type: 'checkbox',
              size: 1
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => {
              let url = `/api/key/rotate_site?site_id=${inputs.siteId}`;
              if (inputs.minAge) {
                url += `&min_age_seconds=${inputs.minAge}`;
              }
              if (inputs.force) {
                url += '&force=true';
              }
              return url;
            }
          }
        },
        {
          id: 'doRotateKeysetKey',
          title: 'Rotate Keyset Key',
          role: 'maintainer',
          inputs: [
            {
              id: 'keysetId-rotateKeyset',
              name: 'keysetId',
              label: 'Keyset ID',
              required: true,
              size: 1,
              type: 'number'
            },
            {
              id: 'minAge-rotateKeyset',
              name: 'minAge',
              label: 'Min Age (seconds)',
              required: false,
              size: 1,
              type: 'number'
            },
            {
              id: 'force-rotateKeyset',
              name: 'force',
              label: 'Force',
              type: 'checkbox',
              size: 1
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => {
              let url = `/api/key/rotate_keyset_key?keyset_id=${inputs.keysetId}`;
              if (inputs.minAge) {
                url += `&min_age_seconds=${inputs.minAge}`;
              }
              if (inputs.force) {
                url += '&force=true';
              }
              return url;
            }
          }
        },
        {
          id: 'doRotateMaster',
          title: 'Rotate Master Keys',
          role: 'maintainer',
          inputs: [
            {
              id: 'minAge-master',
              name: 'minAge',
              label: 'Min Age (seconds)',
              required: false,
              size: 1,
              type: 'number'
            },
            {
              id: 'force-master',
              name: 'force',
              label: 'Force',
              type: 'checkbox',
              size: 1
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => {
              let url = '/api/key/rotate_master';
              const params = [];
              if (inputs.minAge) {
                params.push(`min_age_seconds=${inputs.minAge}`);
              }
              if (inputs.force) {
                params.push('force=true');
              }
              if (params.length > 0) {
                url += '?' + params.join('&');
              }
              return url;
            }
          }
        },
        {
          id: 'doRotateAllSites',
          title: 'Rotate All Site Keys',
          role: 'maintainer',
          inputs: [
            {
              id: 'minAge-all',
              name: 'minAge',
              label: 'Min Age (seconds)',
              required: false,
              size: 1,
              type: 'number'
            },
            {
              id: 'force-all',
              name: 'force',
              label: 'Force',
              type: 'checkbox',
              size: 1
            }
          ],
          apiCall: {
            method: 'POST',
            getUrl: (inputs) => {
              let url = '/api/key/rotate_all_sites';
              const params = [];
              if (inputs.minAge) {
                params.push(`min_age_seconds=${inputs.minAge}`);
              }
              if (inputs.force) {
                params.push('force=true');
              }
              if (params.length > 0) {
                url += '?' + params.join('&');
              }
              return url;
            }
          },
          postProcess: (response) => response.sort((a, b) => a.id - b.id)
        }
      ]
    }
  ];

  initializeOperations(operationConfig);
  initializeOutput();
});
</script>

</body>
</html>